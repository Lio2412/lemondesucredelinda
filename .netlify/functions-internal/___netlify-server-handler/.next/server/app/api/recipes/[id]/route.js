"use strict";(()=>{var e={};e.id=2645,e.ids=[2645],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},59796:e=>{e.exports=require("zlib")},52586:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>I,patchFetch:()=>w,requestAsyncStorage:()=>b,routeModule:()=>E,serverHooks:()=>h,staticGenerationAsyncStorage:()=>y});var i={};t.r(i),t.d(i,{DELETE:()=>x,PUT:()=>v});var n=t(49303),a=t(88716),s=t(60670),o=t(72331),p=t(85662),u=t(87070),c=t(79843),l=t(7410);let d="images",m=e=>{try{let r=new URL(e),t=`/storage/v1/object/public/${d}/`;if(r.pathname.startsWith(t))return r.pathname.substring(t.length);return null}catch(e){return console.error("Erreur extraction chemin URL Supabase:",e),null}},g=l.z.object({name:l.z.string().min(1),quantity:l.z.number().positive(),unit:l.z.string().min(1)}),f=l.z.object({description:l.z.string().min(10),duration:l.z.number().int().positive().optional()});async function x(e,{params:r}){let t=r.id;if(!t)return u.NextResponse.json({error:"ID recette manquant"},{status:400});try{let e=await o._.recipe.findUnique({where:{id:t},select:{image:!0}});if(await o._.recipe.delete({where:{id:t}}),e?.image){let r=m(e.image);if(r){console.log(`Tentative suppression image: ${r}`);let{error:e}=await p.p.storage.from(d).remove([r]);e?console.error(`Erreur suppression image ${r} Supabase:`,e):console.log(`Image ${r} supprim\xe9e Supabase.`)}}return console.log(`Recette supprim\xe9e: ${t}`),u.NextResponse.json({success:!0})}catch(e){if(console.error(`Erreur suppression recette ${t}:`,e),e instanceof Error&&"code"in e&&"P2025"===e.code)return u.NextResponse.json({error:"Recette non trouv\xe9e"},{status:404});return u.NextResponse.json({error:"Erreur interne serveur"},{status:500})}}async function v(e,{params:r}){let t=r.id;if(!t)return u.NextResponse.json({error:"ID recette manquant"},{status:400});try{let r,i,n,a,s,x,v,E,b,y,h,I,w;let j=e.headers.get("content-type");if(j?.includes("multipart/form-data")){let t=await e.formData();r=t.get("title"),i=t.get("slug"),n=t.get("description"),a=t.get("difficulty"),s=t.get("prepTime")?parseInt(t.get("prepTime"),10):void 0,x=t.get("cookTime")?parseInt(t.get("cookTime"),10):void 0,v=parseInt(t.get("basePortions"),10),E=t.get("category");let o=t.get("ingredients"),p=t.get("steps"),c=t.get("image");if(w=t.get("currentImageUrl"),!r||!i||!v||!o||!p)return u.NextResponse.json({error:"Donn\xe9es FormData manquantes"},{status:400});try{b=l.z.array(g).min(1).parse(JSON.parse(o)),y=l.z.array(f).min(1).parse(JSON.parse(p))}catch(e){return u.NextResponse.json({error:"Donn\xe9es ingr\xe9dients/\xe9tapes invalides",details:e},{status:400})}c?h=c:I=w}else{if(!j?.includes("application/json"))return u.NextResponse.json({error:"Content-Type non support\xe9"},{status:415});let p=await e.json();if(r=p.title,i=p.slug,n=p.description,a=p.difficulty,s=p.prepTime,x=p.cookTime,v=p.basePortions,E=p.category,b=l.z.array(g).min(1).parse(p.ingredients),y=l.z.array(f).min(1).parse(p.steps),"string"==typeof p.image)I=p.image;else{let e=await o._.recipe.findUnique({where:{id:t},select:{image:!0}});I=e?.image??void 0}}if(h){let e=h.name.split(".").pop(),r=`${(0,c.Z)()}.${e}`,t=`recipes/${r}`,{error:i}=await p.p.storage.from(d).upload(t,h);if(i)throw console.error("Erreur upload Supabase:",i),Error("Impossible d'uploader la nouvelle image.");let{data:n}=p.p.storage.from(d).getPublicUrl(t);if(!n?.publicUrl)throw console.error("Erreur r\xe9cup\xe9ration URL publique Supabase:",t),Error("Impossible d'obtenir l'URL publique.");if(I=n.publicUrl,console.log(`Nouvelle image upload\xe9e: ${I}`),w){let e=m(w);if(e){console.log(`Tentative suppression ancienne image: ${e}`);let{error:r}=await p.p.storage.from(d).remove([e]);r?console.error(`Erreur suppression ancienne image ${e}:`,r):console.log(`Ancienne image ${e} supprim\xe9e.`)}}}let q=await o._.$transaction(async e=>{let o=await e.recipe.update({where:{id:t},data:{title:r,slug:i,description:n,difficulty:a,prepTime:s,cookTime:x,basePortions:v,category:E,image:I}});return await e.ingredient.deleteMany({where:{recipeId:t}}),await e.recipeStep.deleteMany({where:{recipeId:t}}),await e.ingredient.createMany({data:b.map(e=>({...e,recipeId:t}))}),await e.recipeStep.createMany({data:y.map((e,r)=>({order:r+1,description:e.description,duration:e.duration,recipeId:t}))}),o});return console.log(`Recette mise \xe0 jour: ${t}`),u.NextResponse.json(q)}catch(i){console.error(`Erreur mise \xe0 jour recette ${t}:`,i);let e="Erreur interne serveur",r=500;return i instanceof l.z.ZodError?(e="Donn\xe9es invalides",r=400):i instanceof Error&&(e=i.message,"code"in i&&("P2025"===i.code?(e="Recette non trouv\xe9e",r=404):"P2002"===i.code&&"meta"in i&&"object"==typeof i.meta&&i.meta&&"target"in i.meta&&Array.isArray(i.meta.target)&&i.meta.target.includes("slug")&&(e="Ce slug est d\xe9j\xe0 utilis\xe9 par une autre recette.",r=409))),u.NextResponse.json({error:e},{status:r})}}let E=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/recipes/[id]/route",pathname:"/api/recipes/[id]",filename:"route",bundlePath:"app/api/recipes/[id]/route"},resolvedPagePath:"C:\\Users\\Win\\Desktop\\nouveau-projet-linda\\app\\api\\recipes\\[id]\\route.ts",nextConfigOutput:"standalone",userland:i}),{requestAsyncStorage:b,staticGenerationAsyncStorage:y,serverHooks:h}=E,I="/api/recipes/[id]/route";function w(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:y})}},72331:(e,r,t)=>{t.d(r,{_:()=>n});var i=t(53524);let n=global.prisma||new i.PrismaClient({})},85662:(e,r,t)=>{t.d(r,{p:()=>o});var i=t(31518);let n="https://pbqkgspugfjyrgkrciln.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBicWtnc3B1Z2ZqeXJna3JjaWxuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM3ODEwMjEsImV4cCI6MjA1OTM1NzAyMX0.iVzx8WOoyVE-RRj2KzdPZB0LNiixikgPSnAtAkE_8es";if(!n)throw Error("La variable d'environnement NEXT_PUBLIC_SUPABASE_URL est manquante.");if(!a)throw Error("La variable d'environnement NEXT_PUBLIC_SUPABASE_ANON_KEY est manquante.");(0,i.eI)(n,a);let s=process.env.SUPABASE_SERVICE_ROLE;s||console.warn("La variable d'environnement SUPABASE_SERVICE_ROLE est manquante. Les op\xe9rations admin Supabase pourraient \xe9chouer.");let o=(0,i.eI)(n,s||"")}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),i=r.X(0,[1633,5972,7076,7410],()=>t(52586));module.exports=i})();